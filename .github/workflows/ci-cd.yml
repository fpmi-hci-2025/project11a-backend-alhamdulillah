name: Simple CI/CD Pipeline

on:
  push:
    branches: [ main, master, development, production ]
  pull_request:
    branches: [ main, master, development, production ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run simple Python test
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
        python -c "from app import app; print('‚úÖ App imported successfully')"
        echo "Basic test passed!"

  docker-build-test:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Build Docker image
      run: |
        docker build -t makhachkala-hello:latest .
    
    - name: Test Docker container
      run: |
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
        docker run -d --name test-container -p 8080:8000 makhachkala-hello:latest
        
        # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        echo "Waiting for app to start..."
        sleep 5
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint
        echo "Testing health endpoint..."
        HEALTH_RESPONSE=$(curl -s -f http://localhost:8080/api/health || echo "FAILED")
        
        if [[ "$HEALTH_RESPONSE" == "FAILED" ]]; then
          echo "‚ùå Health check failed"
          docker logs test-container
          exit 1
        fi
        
        echo "Health response:"
        echo "$HEALTH_RESPONSE" | python -m json.tool
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π endpoint
        echo "Testing main endpoint..."
        curl -s http://localhost:8080/ | python -m json.tool
        
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        echo "Cleaning up..."
        docker stop test-container
        docker rm test-container
        
        echo "‚úÖ All Docker tests passed!"

  deploy:
    needs: docker-build-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Login to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    
    - name: Deploy to Render
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      run: |
        echo "üöÄ Triggering Render deployment..."
        curl -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{"clearCache": true}' || echo "Render deploy trigger might have failed, but continuing..."
